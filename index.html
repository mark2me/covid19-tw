<html lang="zh-Hant">
    <head>
        <title>2021 台灣本土 COVID-19 確診案例日期統計表</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </head>
    <body style="padding: 20px;">

        <h3 style="text-align: center;">地區年齡性別統計表-嚴重特殊傳染性肺炎-依個案研判日統計</h3>

        <div id="chart_div" style="height: 400px; width: 100%; max-width: 1600px; margin: 20px auto 0;"></div>

        <p style="text-align: center;">
            資料來源：<a href="https://data.cdc.gov.tw/dataset/agsdctable-day-19cov" target="_blank">https://data.cdc.gov.tw/dataset/agsdctable-day-19cov</a>
        </p>


        <script>
        var citys = {};
        var days = {};

        $(function(){

            var url = "https://data.cdc.gov.tw/api/3/action/datastore_search_sql";
            var sql = {
                sql:  'SELECT 個案研判日 as dd,縣市 as cy,性別 as sex,確定病例數 as n from "3c1e263d-16ec-4d70-b56c-21c9e2171fc7" WHERE 是否為境外移入=\'否\' AND 個案研判日>=\'20210511\''
            }

            $.ajax({
                url: url,
                data: sql,
                cache: true,
                dataType: 'jsonp',
                success: function(data) {

                    //alert('Total results found: ' + data.result.total)
                    $('#total').text(data.result.total);

                    $.each( data.result.records , function(index,val){
                        //if( val.個案研判日 > 20210501 ){

                        if( !days[val.dd] ){
                            days[val.dd] = {};
                        }

                        if( days[val.dd][val.cy] ){
                            days[val.dd][val.cy] += parseInt(val.n);
                        }else{
                            days[val.dd][val.cy] = parseInt(val.n);
                        }

                        if( data.result.records.length == (index+1)){
                            console.log(days);
                            google.charts.load('current', {packages: ['corechart', 'bar']});
                            google.charts.setOnLoadCallback(drawBasic);
                        }
                    });
                }
            });

            $(window).resize(function() {
                if(this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function() {
                    $(this).trigger('resizeEnd');
                }, 500);
            });


            $(window).on('resizeEnd', function() {
                drawBasic();
            });
        });

        function drawBasic() {

            var row = [];
            row.push(['個案研判日', { role: 'annotation' }, '其他縣市', '新北市', '台北市' ]);  //{ role: 'annotation' }
            $.each(days,function(d,v){
                var tol = 0;
                $.each(v, function(d2,v2){
                    tol += parseInt(v2);
                });
                row.push([ (d.substring(4,6)+'/'+d.substring(6)) , tol, (tol - v.台北市 - v.新北市), v.新北市 , v.台北市 ]);
            });

            console.log(row);

            var data = google.visualization.arrayToDataTable(row);

            var options = {
                title: '台灣本土確診案例數',
                subtitle: '從2021-05-11',
                bar: {groupWidth: "80%"},
                isStacked: 'absolute',
                vAxis:{
                    title: '每日總計案例數'
                },
                hAxis:{
                    title: '個案研判日期（非校正回歸）'
                }
            };

            var chart = new google.visualization.ColumnChart( document.getElementById('chart_div') );
            chart.draw(data, options);
        }
        </script>


    </body>
</html>