<html lang="zh-Hant">
    <head>
        <title>2021 台灣本土 COVID-19 確診案例日期統計表</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-4-grid@3.4.0/css/grid.min.css" integrity="sha256-raGUlaaCI4l2GoQ6cxLH8ODuDTwuQVL9RU06sSvpD6w=" crossorigin="anonymous">
    </head>
    <body style="padding: 20px;">

        <h3 style="text-align: center;">2021 台灣本土 COVID-19 確診案例統計-依個案研判日統計</h3>

        <div id="chart_div" style="height: 400px; width: 100%; max-width: 1600px; margin: 20px auto 0;"></div>

        <p style="text-align: center;">
            資料來源：<a href="https://data.cdc.gov.tw/dataset/agsdctable-day-19cov" target="_blank">https://data.cdc.gov.tw/dataset/agsdctable-day-19cov</a>
        </p>

        <div style="border-top: 1px solid #999;margin-top:50px; padding-bottom: 20px;">&nbsp;</div>
        <div class="container-fluid">
            <h3 style="text-align: center;">台北市 <span id="tol_taipei"></span></h3>
            <div id="zone_taipei" class="row">
            </div>
        </div>

        <div style="border-top: 1px solid #999;margin-top:50px; padding-bottom: 20px;">&nbsp;</div>

        <div class="container-fluid">
            <h3 style="text-align: center;">新北市 <span id="tol_newtaipei"></span></h3>
            <div id="zone_newtaipei" class="row">
            </div>
        </div>

        <script>
        var citys = {};
        var days = {};
        var colors = ['#0066ff','#29a329','#ff6600','#ff3399','#ffff00','#cc3300','#33ccff','#000099','#666699','#336600'];

        $(function(){

            /*
            var endPo = "https://data.cdc.gov.tw/api/3/action/datastore_search_sql";
            var args = {
                sql:  'SELECT 個案研判日 as dd,縣市 as cy,性別 as sex,確定病例數 as n from "3c1e263d-16ec-4d70-b56c-21c9e2171fc7" WHERE 是否為境外移入=\'否\' AND 個案研判日>=\'20210511\''
            }
            */

            /*
            var endPo = 'https://data.cdc.gov.tw/api/3/action/datastore_search';
            var args = {
                resource_id: '3c1e263d-16ec-4d70-b56c-21c9e2171fc7', // the resource id
                limit: 5000,
                filters: '{"是否為境外移入":"否","個案研判日":"20210511"}'
                //q: 'abc'
            }

            $.ajax({
                url: endPo,
                data: args,
                dataType: 'jsonp',
                cache: true,
                success: function(data) {
                    console.log(data);
                }
            });
            */

            $.getJSON( "Day_Confirmation_Age_County_Gender_19CoV.json", function( data ) {

                    $.each( data , function(index,val){

                        if( val.個案研判日 <= '20210511' ) return;
                        if( val.是否為境外移入 == '是' ) return;

                        //console.log(index,val);

                        if( !days[val.個案研判日] ) days[val.個案研判日] = {};

                        if( days[val.個案研判日][val.縣市] ){
                            days[val.個案研判日][val.縣市] += parseInt(val.確定病例數)
                        }else{
                            days[val.個案研判日][val.縣市] = parseInt(val.確定病例數)
                        }

                        //
                        if( val.縣市 !== '空值' && !citys[val.縣市] ) citys[val.縣市] = {};
                        if( val.個案研判日 !== '' && !citys[val.縣市][val.鄉鎮] ) citys[val.縣市][val.鄉鎮] = {};
                        if( citys[val.縣市][val.鄉鎮][val.個案研判日] ){
                            citys[val.縣市][val.鄉鎮][val.個案研判日] +=  parseInt(val.確定病例數)
                        }else{
                            citys[val.縣市][val.鄉鎮][val.個案研判日] =  parseInt(val.確定病例數)
                        }

                    });

                    //console.log(days);
                    google.charts.load('current', {packages: ['corechart', 'bar']});
                    google.charts.setOnLoadCallback(drawAll);

            });

            $(window).resize(function() {
                if(this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function() {
                    $(this).trigger('resizeEnd');
                }, 500);
            });


            $(window).on('resizeEnd', function() {
                drawAll();
            });
        });


        function drawAll() {

            var row = [];
            row.push(['個案研判日', { role: 'annotation' }, '其他縣市', '新北市', '台北市' ]);  //{ role: 'annotation' }
            $.each(days,function(d,v){
                var tol = 0;
                $.each(v, function(d2,v2){
                    tol += parseInt(v2);
                });
                row.push([ (d.substring(4,6)+'/'+d.substring(6)) , tol, (tol - v.台北市 - v.新北市), v.新北市 , v.台北市 ]);
            });

            var data = new google.visualization.arrayToDataTable(row);

            var options = {
                //title: '台灣本土確診案例數',
                subtitle: '從2021-05-11',
                bar: {groupWidth: "80%"},
                isStacked: 'absolute',
                vAxis:{
                    title: '每日總計案例數'
                },
                hAxis:{
                    title: '個案研判日期（非校正回歸）'
                }
            };

            var chart = new google.visualization.ColumnChart( document.getElementById('chart_div') );
            chart.draw(data, options);

            // 台北市
            drawCity(citys.台北市, 'taipei');
            drawCity(citys.新北市, 'newtaipei');
        }

        function drawCity(cdata,cname) {

            var ct_total = 0;

            $.each(cdata,function(zname,nums){

                var row = [];
                var color = colors[Math.floor(Math.random() * colors.length)];
                var total = 0;

                row.push(['個案研判日', '數量', { role: 'style' } ]);
                $.each(days,function(d){
                    total += parseInt( (nums[d] ? nums[d]:0) );
                    row.push([
                        (d.substring(4,6)+'/'+d.substring(6)) ,
                        (nums[d] ? nums[d]:0),
                        color
                    ]);
                });

                var dom = $('<div>').attr('id',zname).attr('data-nums',total).addClass('city col-12 col-md-6 col-lg-4 pb-5').appendTo( $('#zone_'+cname) );

                ct_total += total;

                var data = new google.visualization.arrayToDataTable(row);
                var options = {
                    title: zname + ' ('+total+' 例)',
                    bar: {groupWidth: "60%"},
                    legend: { position: "none" },
                    vAxis:{
                        maxValue: 200,
                        title: '日案例數'
                    },
                    hAxis:{
                        title: '個案研判日期（非校正回歸）'
                    }
                };

                var chart = new google.visualization.ColumnChart( document.getElementById(zname) );
                chart.draw(data, options);
            });

            $('#tol_'+cname).text(ct_total);

            // sort
            for( i=0 ; i< $('#zone_'+cname+' .city').length ; i++){
                for( j=0 ; j< $('#zone_'+cname+' .city').length ; j++){
                    $c1 = $('#zone_'+cname+' .city').eq(j);
                    $c2 = $('#zone_'+cname+' .city').eq(j+1);
                    if( $c1.data('nums') < $c2.data('nums') ){
                        $c1.before($c2);
                    }
                }
            }


        }
        </script>


    </body>
</html>