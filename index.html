<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <title>2022 台灣本土 COVID-19 確診案例日期統計表</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-4-grid@3.4.0/css/grid.min.css" integrity="sha256-raGUlaaCI4l2GoQ6cxLH8ODuDTwuQVL9RU06sSvpD6w=" crossorigin="anonymous">
        <style>
        .section_city{ border-top: 1px solid #999;margin-top:50px; padding-top: 20px; }
        .section_city h3{ text-align: center;}
        </style>
    </head>
    <body style="margin:0;padding-top: 20px;">

        <div class="container-fluid">
            <h3 style="text-align: center;">2022 台灣本土 COVID-19 確診案例統計-依個案研判日統計</h3>
            <p style="text-align: center;">
            資料來源：<a href="https://data.cdc.gov.tw/dataset/aagstable-day-19cov" target="_blank">https://data.cdc.gov.tw/dataset/aagstable-day-19cov</a>
            </p>
        </div>

        <div class="container-fluid">
            <div id="tw_day_chart" style="height: 400px; width: 100%; max-width: 1600px; margin: 20px auto 0;"></div>
        </div>

        <div class="container-fluid">
            <div id="tw_city_tol_chart" style="height: 400px; width: 100%; max-width: 1600px; margin: 20px auto 0;"></div>
        </div>

        <div class="container-fluid">
            <div id="city_day_chart" class="row" style="width: 100%;margin: 20px auto 0;"></div>
        </div>



        <script>
        var tw_day = {};
        var tw_city_tol = {};
        var city_day = {};

        var city_zone_tol = {}


//        var cityName = ['台北市','新北市','桃園市','台中市','台南市','高雄市','基隆市','新竹市','新竹縣','苗栗縣','南投縣','彰化縣','雲林縣','嘉義市','嘉義縣','屏東縣','宜蘭縣','花蓮縣','台東縣','澎湖縣','金門縣'];

        var colors = ['#0066ff','#29a329','#ff6600','#ff3399','#ffff00','#cc3300','#33ccff','#000099','#666699','#336600'];

        $(function(){

            $.getJSON( "Day_Confirmation_Age_County_Gender_19CoV.json", function( data ) {

                $.each( data , function(index,val){

                    if( val.個案研判日 < '2022/01/01' ) return;
                    if( val.是否為境外移入 == '是' ) return;

                    // calc by days
                    if( !tw_day[val.個案研判日] ) tw_day[val.個案研判日] = {};

                    if( tw_day[val.個案研判日][val.縣市] ){
                        tw_day[val.個案研判日][val.縣市] += parseInt(val.確定病例數)
                    }else{
                        tw_day[val.個案研判日][val.縣市] = parseInt(val.確定病例數)
                    }

                    // calc Total by city
                    if( !tw_city_tol[val.縣市] ) tw_city_tol[val.縣市] = 0;
                    tw_city_tol[val.縣市] += parseInt(val.確定病例數);


                    //city with zone
                    if( val.縣市 !== '空值' && !city_day[val.縣市] ) city_day[val.縣市] = {};
                    if( val.個案研判日 !== '' && !city_day[val.縣市][val.鄉鎮] ) city_day[val.縣市][val.鄉鎮] = {};
                    if( city_day[val.縣市][val.鄉鎮][val.個案研判日] ){
                        city_day[val.縣市][val.鄉鎮][val.個案研判日] +=  parseInt(val.確定病例數)
                    }else{
                        city_day[val.縣市][val.鄉鎮][val.個案研判日] =  parseInt(val.確定病例數)
                    }


                    //city_zone_tol
                    if( val.縣市 !== '空值' && !city_zone_tol[val.縣市] ) city_zone_tol[val.縣市] = {};
                    if( val.鄉鎮 !== '' && !city_zone_tol[val.縣市][val.鄉鎮] ) city_zone_tol[val.縣市][val.鄉鎮] = 0;
                    if( city_zone_tol[val.縣市][val.鄉鎮] ){
                        city_zone_tol[val.縣市][val.鄉鎮] +=  parseInt(val.確定病例數)
                    }else{
                        city_zone_tol[val.縣市][val.鄉鎮] =  parseInt(val.確定病例數)
                    }

                });


                google.charts.load('current', {packages: ['corechart', 'bar']});
                google.charts.setOnLoadCallback(drawAll);
            });



            $(window).resize(function() {
                if(this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function() {
                    $(this).trigger('resizeEnd');
                }, 500);
            });

            $(window).on('resizeEnd', function() {
                drawAll();
            });
        });


        function drawAll() {

            var row = [];
            row.push(['個案研判日', { role: 'annotation' }, '其他縣市', '新北市', '台北市' ]);  //{ role: 'annotation' }
            $.each(tw_day,function(d,v){
                var tol = 0;
                $.each(v, function(d2,v2){
                    tol += parseInt(v2);
                });
                row.push([ (d.substring(5)) , tol, (tol - v.台北市 - v.新北市), v.新北市 , v.台北市 ]);
            });

            var data = new google.visualization.arrayToDataTable(row);

            var options = {
                //title: '台灣本土確診案例數',
                subtitle: '從2022-01-01',
                bar: {groupWidth: "80%"},
                isStacked: 'absolute',
                vAxis:{
                    title: '每日總計案例數'
                },
                hAxis:{
                    title: '個案研判日期'
                }
            };

            var chart = new google.visualization.ColumnChart( document.getElementById('tw_day_chart') );
            chart.draw(data, options);

            //draw city
            drawCityTol(tw_city_tol);

            drawCityZoneTol('台北市');

            drawCityZoneTol('新北市');

            //drawCityZone('台北市');
            //drawCityZone('新北市');
            //drawCityZone('高雄市');


        }


        function drawCityZone(ctName) {

            //add dom
            var $newCity = $('<div>').attr('id','city_'+ctName).addClass('container-fluid section_city');
            $('<h3>'+ctName+' <span id="city_tol"></span></h3>').appendTo( $newCity );
            var $town_dox = $('<div>').addClass('row towns').appendTo( $newCity );
            $newCity.appendTo( $('#city_day_chart') );

            var ct_total = 0;
            var count = Object.keys(city_day[ctName]).length;

            $.each(city_day[ctName],function(zname,nums){

                var row = [];
                var color = colors[Math.floor(Math.random() * colors.length)];
                var total = 0;
                var maxV = 0;

                row.push(['個案研判日', '數量', { role: 'style' } ]);
                $.each(tw_day,function(d){
                    var n = parseInt( (nums[d] ? nums[d]:0) );
                    if( n >= maxV ) maxV = n;
                    total += n;
                    row.push([
                        (d.substring(5)) ,   // 2021/xx/xx
                        n,
                        color
                    ]);
                });

                $('<div>').attr('id',zname).attr('data-nums',total).addClass('town col-12 col-md-6 col-lg-4 pb-5').appendTo( $town_dox );

                ct_total += total;
                if(maxV<10) maxV = 10;

                var data = new google.visualization.arrayToDataTable(row);
                var options = {
                    title: zname + ' (累計 '+total+' 例)',
                    bar: {groupWidth: "60%"},
                    legend: { position: "none" },
                    vAxis:{
                        maxValue: maxV,
                        title: '日案例數'
                    },
                    hAxis:{
                        title: '個案研判日期（非校正回歸）'
                    }
                };

                var chart = new google.visualization.ColumnChart( document.getElementById(zname) );
                chart.draw(data, options);

                if ( !--count ){

                    $newCity.find('#city_tol').text('共 ' + ct_total + ' 例');
                    //sort
                    var length = $newCity.find('.town').length;
                    for( i=0 ; i< length ; i++){
                        for( j=0 ; j< length ; j++){
                            var $c1 = $newCity.find('.town').eq(j);
                            var $c2 = $newCity.find('.town').eq(j+1);
                            if( parseInt($c1.data('nums')) < parseInt($c2.data('nums')) ){
                                $c1.before($c2);
                            }
                        }
                    }
                }
            });

        }

        function drawCityTol(tw_city_tol){

            const sortable = Object.fromEntries(
                Object.entries(tw_city_tol).sort(([,a],[,b]) => b-a)
            );

            var row = [];
            var maxV = 0;

            row.push(['縣市', '數量', { role: 'style' } , { role: 'annotation' }  ]);
            $.each(sortable,function(zname,nums){
                if( maxV < nums ) maxV = nums;
                row.push([ zname, nums, colors[Math.floor(Math.random() * colors.length)] , nums]);
            });

            var data = new google.visualization.arrayToDataTable(row);
            var options = {
                title: '2022/1月以來 台灣各個城市統計確診數量',
                bar: {groupWidth: "60%"},
                legend: { position: "none" },
                vAxis:{
                    maxValue: (maxV*1.1),
                    title: '案例數'
                },
                hAxis:{
                    title: '城市類別'
                }
            };

            var chart = new google.visualization.ColumnChart( document.getElementById('tw_city_tol_chart') );
            chart.draw(data, options);
        }


        function drawCityZoneTol(city){

            const sortable = Object.fromEntries(
                Object.entries(city_zone_tol[city]).sort(([,a],[,b]) => b-a)
            );

            var $newCity = $('<div>').attr('id','cityzone_'+city).addClass('col-12 col-sm-6');
            $newCity.appendTo( $('#city_day_chart') );

            var row = [];
            var maxV = 0;
            row.push(['區域', '數量', { role: 'style' } , { role: 'annotation' }  ]);
            $.each(sortable,function(zname,nums){
                if( maxV < nums ) maxV = nums;
                row.push([ zname, nums, colors[Math.floor(Math.random() * colors.length)] , nums]);
            });

            var data = new google.visualization.arrayToDataTable(row);
            var options = {
                title: '2022/1月以來 '+city+' 統計確診數量',
                bar: {groupWidth: "60%"},
                legend: { position: "none" },
                vAxis:{
                    maxValue: (maxV*1.1),
                    title: '案例數'
                },
                hAxis:{
                    title: '鄉鎮市區'
                }
            };

            //$('<div>').attr('id',zname).attr('data-nums',total).addClass('town col-12 col-md-6 col-lg-4 pb-5').appendTo( $town_dox );

            var chart = new google.visualization.ColumnChart( document.getElementById('cityzone_'+city) );
            chart.draw(data, options);
        }
        </script>

    </body>
</html>
